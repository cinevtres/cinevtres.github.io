<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Cierre de Caja Cafeter칤a</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      #chatBox div { margin: 10px 0; }
      .question { font-weight: bold; }
      .response { margin-left: 20px; }
      input, select, button { padding: 5px; font-size: 1em; }
      pre { background: #f5f5f5; padding: 10px; border-radius: 5px; }
    </style>
  </head>
  <body>
    <h1>Cierre de Caja Cafeter칤a</h1>

    <!-- Seleccionar mes y d칤a -->
    <label for="mes">Selecciona el mes:</label>
    <select id="mes">
      <option>Enero</option>
      <option>Febrero</option>
      <option>Marzo</option>
      <option>Abril</option>
      <option>Mayo</option>
      <option>Junio</option>
      <option>Julio</option>
      <option>Agosto</option>
      <option>Septiembre</option>
      <option>Octubre</option>
      <option>Noviembre</option>
      <option>Diciembre</option>
    </select>

    <label for="dia">Selecciona el d칤a:</label>
    <input type="number" id="dia" min="1" max="31">

    <!-- Botones para registrar y ver datos -->
    <button onclick="startEntry()">Registrar Cierre</button>
    <button onclick="getResults()">Ver Datos del D칤a</button>
    <button onclick="getMonthResults()">Ver Datos del Mes</button>

    <div id="chatBox"></div>
    <div id="resultados"></div>

    <script>
      // Orden de las cabeceras seg\u00FAn el Excel
      var headerOrder = [
        "Fecha",
        "Ventas en efectivo",
        "Ventas con tarjeta",
        "Total ingresos",
        "Saldo inicial",
        "Ingresos efectivo (de ventas)",
        "Retiradas",
        "Gastos menores",
        "Saldo final",
        "Efectivo te칩rico (seg칰n TPV)",
        "Efectivo real (contado f칤sicamente)",
        "Descuadre",
        "Comentarios",
        "Cambio final",
        "Retiro a sobre / caja fuerte"
      ];

      // Preguntas del flujo de registro. Solo se solicitan los datos de entrada.
      var questions = [
        { key: "efectivo", text: "游눯 Introduce Ventas en efectivo:" },
        { key: "tarjeta", text: "游눱 Introduce Ventas con tarjeta:" },
        { key: "inicial", text: "游닍 Introduce Saldo inicial:" },
        { key: "retiradas", text: "游댵 Introduce Retiradas:" },
        { key: "gastos", text: "游븱 Introduce Gastos menores:" },
        { key: "contado", text: "游눴 Introduce Efectivo real (contado f칤sicamente):" },
        { key: "comentarios", text: "游닇 Introduce Comentarios (opcional):", type:"text" },
        { key: "cambio", text: "游눺 Introduce Cambio final:" }
      ];

      var userData = {};
      var currentQuestion = 0;

      // Inicia el registro (se leen mes y d칤a)
      function startEntry() {
        userData.mes = document.getElementById("mes").value;
        userData.dia = document.getElementById("dia").value;
        if (!userData.dia) {
          alert("Selecciona un d칤a v치lido.");
          return;
        }
        currentQuestion = 0;
        document.getElementById("chatBox").innerHTML = "";
        askQuestion();
      }

      // Muestra cada pregunta
      function askQuestion() {
        if (currentQuestion < questions.length) {
          var chatBox = document.getElementById('chatBox');
          var qDiv = document.createElement('div');
          qDiv.className = "question";
          qDiv.textContent = questions[currentQuestion].text;
          chatBox.appendChild(qDiv);

          var input = document.createElement('input');
          // Si la pregunta es de tipo texto (por ejemplo, comentarios), cambiar el tipo
          input.type = (questions[currentQuestion].type) ? questions[currentQuestion].type : "number";
          if(input.type=="number") { input.step = "any"; }
          input.id = questions[currentQuestion].key;
          input.placeholder = "Ingresa un valor";
          chatBox.appendChild(input);

          var btn = document.createElement('button');
          btn.textContent = "Enviar";
          btn.onclick = submitAnswer;
          chatBox.appendChild(btn);
          input.focus();
        } else {
          finalizeData();
        }
      }

      function submitAnswer() {
        var key = questions[currentQuestion].key;
        var inputElem = document.getElementById(key);
        var value = (inputElem.type=="number") ? parseFloat(inputElem.value) : inputElem.value;
        if (inputElem.type=="number" && isNaN(value)) {
          alert("Por favor, introduce un n칰mero v치lido.");
          return;
        }
        userData[key] = value;
        var chatBox = document.getElementById('chatBox');
        var respDiv = document.createElement('div');
        respDiv.className = "response";
        respDiv.textContent = value;
        chatBox.appendChild(respDiv);
        currentQuestion++;
        askQuestion();
      }

      // Finaliza el registro y decide si actualizar o guardar nuevo registro.
      function finalizeData() {
        var mes = userData.mes;
        var dia = userData.dia;
        google.script.run.withSuccessHandler(function(resp) {
          if (resp !== null) {  // Existe la fila para ese d칤a
            if (resp.hasData) {
              var proceed = confirm("Ya existen datos para este d칤a. 쮻eseas actualizar los datos existentes?");
              if (proceed) {
                google.script.run.withSuccessHandler(function(resp2) {
                  alert(resp2);
                  location.reload();
                }).updateData(userData);
              } else {
                alert("Operaci칩n cancelada. No se ha modificado el registro existente.");
              }
            } else {
              // La fila existe pero no tiene datos de entrada: se actualiza sin preguntar.
              google.script.run.withSuccessHandler(function(resp3) {
                alert(resp3);
                location.reload();
              }).updateData(userData);
            }
          } else {
            // No se encontr칩 fila: se guarda como registro nuevo.
            google.script.run.withSuccessHandler(function(resp4) {
              alert(resp4);
              location.reload();
            }).saveData(userData);
          }
        }).getData(mes, dia);
      }

      // Muestra los datos del d칤a solicitado de forma vertical, respetando el orden de la cabecera.
      function getResults() {
        var mes = document.getElementById("mes").value;
        var dia = document.getElementById("dia").value;
        if (!dia) {
          alert("Selecciona un d칤a v치lido.");
          return;
        }
        google.script.run.withSuccessHandler(function(resp) {
          var output = "<h2>Resultados del D칤a</h2><pre>";
          if (typeof resp === "string") {
          output += resp;
          } else {
            headerOrder.forEach(function(key) {
              var value = resp.rowData[key];
              if (typeof value === "number") {
                value = value.toFixed(2); // Redondea a dos decimales
              }
              output += key + ": " + (value !== undefined ? value : "") +  "\n";
            });
          }
          output += "</pre>";
          document.getElementById("resultados").innerHTML = output;
        }).getData(document.getElementById("mes").value, dia);
      }


      // Muestra la suma (agregada) de cada columna del mes, listada verticalmente.
      function getMonthResults() {
        var mes = document.getElementById("mes").value;
        google.script.run.withSuccessHandler(function(resp) {
          var output = "<h2>Resultados Agregados del Mes</h2><pre>";
          if (typeof resp === "string") {
            output += resp;
        } else {
          output += "Fecha: Total\n"; 
          for (var i = 1; i < headerOrder.length; i++) {
            var key = headerOrder[i];
            var value = resp[key];
            if (typeof value === "number") {
              value = value.toFixed(2);
            }
            output += key + ": " + (value !== undefined ? value : "") + "\n";
          }
        }
          output += "</pre>";
          document.getElementById("resultados").innerHTML = output;
        }).getDataMonth(mes);
      }
      
    </script>
  </body>
</html>
